<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 Frontend Tests - DonWatcher</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background: #0d1b2a;
            color: #e0e0e0;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: #1b263b;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #82b1ff;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-pass {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4caf50;
        }
        .test-fail {
            background: rgba(255, 82, 82, 0.2);
            border-left: 4px solid #ff5252;
        }
        .test-warning {
            background: rgba(255, 152, 0, 0.2);
            border-left: 4px solid #ff9800;
        }
        button {
            background: #82b1ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #448aff;
        }
        .mock-data {
            background: #152238;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Phase 2 Frontend Testing Suite</h1>
        <p>Comprehensive tests for Domain Group Management UI components</p>

        <div class="test-section">
            <h2>üéØ Group Manager API Client Tests</h2>
            <div id="api-tests"></div>
            <button onclick="runApiTests()">Run API Tests</button>
        </div>

        <div class="test-section">
            <h2>üé® Enhanced Group Tiles Tests</h2>
            <div id="tile-tests"></div>
            <button onclick="runTileTests()">Run Tile Tests</button>
        </div>

        <div class="test-section">
            <h2>üìã Member Modal Tests</h2>
            <div id="modal-tests"></div>
            <button onclick="runModalTests()">Run Modal Tests</button>
        </div>

        <div class="test-section">
            <h2>üì± Responsive Design Tests</h2>
            <div id="responsive-tests"></div>
            <button onclick="runResponsiveTests()">Run Responsive Tests</button>
        </div>

        <div class="test-section">
            <h2>üîÑ Integration Tests</h2>
            <div id="integration-tests"></div>
            <button onclick="runIntegrationTests()">Run Integration Tests</button>
        </div>

        <div class="test-section">
            <h2>üé¨ Demo Components</h2>
            <p>Interactive demo of Phase 2 components</p>
            <button onclick="showDemoTile()">Demo Group Tile</button>
            <button onclick="showDemoModal()">Demo Member Modal</button>
            <div id="demo-area"></div>
        </div>
    </div>

    <!-- Load Phase 2 components -->
    <script src="../server/frontend/groupManager.js"></script>
    <script src="../server/frontend/memberModal.js"></script>
    <link rel="stylesheet" href="../server/frontend/styles.css">

    <script>
        // Test utilities
        function addTestResult(containerId, testName, passed, message = '') {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            result.innerHTML = `
                <strong>${testName}</strong>: ${passed ? '‚úÖ PASS' : '‚ùå FAIL'}
                ${message ? `<br><small>${message}</small>` : ''}
            `;
            container.appendChild(result);
        }

        function addTestWarning(containerId, testName, message) {
            const container = document.getElementById(containerId);
            const result = document.createElement('div');
            result.className = 'test-result test-warning';
            result.innerHTML = `
                <strong>${testName}</strong>: ‚ö†Ô∏è WARNING
                <br><small>${message}</small>
            `;
            container.appendChild(result);
        }

        // Mock data for testing
        const mockGroupData = [
            {
                group_name: "Domain Admins",
                total_members: 3,
                accepted_members: 1,
                unaccepted_members: 2,
                risk_score: 40,
                severity: "high",
                last_updated: new Date().toISOString()
            },
            {
                group_name: "Enterprise Admins",
                total_members: 1,
                accepted_members: 1,
                unaccepted_members: 0,
                risk_score: 0,
                severity: "low",
                last_updated: new Date().toISOString()
            }
        ];

        const mockMemberData = {
            group_name: "Domain Admins",
            domain: "test.local",
            total_members: 3,
            accepted_members: 1,
            members: [
                {
                    name: "Administrator",
                    samaccountname: "Administrator",
                    sid: "S-1-5-21-1234567890-1234567890-1234567890-500",
                    type: "user",
                    enabled: true,
                    is_accepted: true
                },
                {
                    name: "john.doe",
                    samaccountname: "john.doe",
                    sid: "S-1-5-21-1234567890-1234567890-1234567890-1001",
                    type: "user",
                    enabled: true,
                    is_accepted: false
                },
                {
                    name: "CORP-DC01$",
                    samaccountname: "CORP-DC01$",
                    sid: "S-1-5-21-1234567890-1234567890-1234567890-1000",
                    type: "computer",
                    enabled: true,
                    is_accepted: false
                }
            ]
        };

        // API Tests
        async function runApiTests() {
            const container = document.getElementById('api-tests');
            container.innerHTML = '<p>Running API client tests...</p>';

            try {
                // Test GroupManager instantiation
                const groupManager = new GroupManager();
                addTestResult('api-tests', 'GroupManager Instantiation', 
                    groupManager instanceof GroupManager, 
                    'GroupManager class instantiated successfully');

                // Test cache functionality
                const cacheStats = groupManager.getCacheStats();
                addTestResult('api-tests', 'Cache System', 
                    typeof cacheStats === 'object' && 'entries' in cacheStats,
                    `Cache initialized with ${cacheStats.entries} entries`);

                // Test URL encoding
                const testDomain = 'test domain.local';
                const encodedDomain = encodeURIComponent(testDomain);
                addTestResult('api-tests', 'URL Encoding', 
                    encodedDomain === 'test%20domain.local',
                    'Domain names with spaces are properly encoded');

                // Test error handling
                try {
                    await groupManager.getDomainGroups('nonexistent.domain');
                    addTestResult('api-tests', 'Error Handling', false, 'Should have thrown an error');
                } catch (error) {
                    addTestResult('api-tests', 'Error Handling', true, 
                        'Properly handles API errors: ' + error.message);
                }

                // Test bulk operations structure
                const bulkResult = await groupManager.bulkAcceptMembers('test.local', 'Test Group', ['user1', 'user2']);
                addTestResult('api-tests', 'Bulk Operations Structure', 
                    'successful' in bulkResult && 'failed' in bulkResult && 'total' in bulkResult,
                    'Bulk operation results have correct structure');

            } catch (error) {
                addTestResult('api-tests', 'API Tests', false, `Unexpected error: ${error.message}`);
            }
        }

        // Tile Tests
        function runTileTests() {
            const container = document.getElementById('tile-tests');
            container.innerHTML = '<p>Running tile component tests...</p>';

            try {
                // Test enhanced tile creation
                const mockGroup = mockGroupData[0];
                const mockDomain = 'test.local';

                // Create tile element (simulate the function from home.js)
                const tile = createTestGroupTile(mockGroup, mockDomain);
                
                addTestResult('tile-tests', 'Tile Creation', 
                    tile instanceof HTMLElement, 
                    'Enhanced group tile created successfully');

                addTestResult('tile-tests', 'Risk Badge', 
                    tile.querySelector('.group-risk-badge') !== null,
                    'Risk badge element present');

                addTestResult('tile-tests', 'Acceptance Status', 
                    tile.querySelector('.group-status') !== null,
                    'Acceptance status indicator present');

                addTestResult('tile-tests', 'Enhanced Stats', 
                    tile.querySelector('.group-stats-enhanced') !== null,
                    'Enhanced statistics section present');

                addTestResult('tile-tests', 'Progress Bar', 
                    tile.querySelector('.acceptance-bar') !== null,
                    'Acceptance progress bar present');

                addTestResult('tile-tests', 'Management Button', 
                    tile.querySelector('.btn-manage') !== null,
                    'Manage members button present');

                // Test acceptance rate calculation
                const acceptanceRate = Math.round((mockGroup.accepted_members / mockGroup.total_members) * 100);
                addTestResult('tile-tests', 'Acceptance Rate Calculation', 
                    acceptanceRate === 33, 
                    `Calculated ${acceptanceRate}% acceptance rate`);

            } catch (error) {
                addTestResult('tile-tests', 'Tile Tests', false, `Error: ${error.message}`);
            }
        }

        // Modal Tests
        function runModalTests() {
            const container = document.getElementById('modal-tests');
            container.innerHTML = '<p>Running modal component tests...</p>';

            try {
                // Test modal instantiation
                const modal = new MemberModal();
                addTestResult('modal-tests', 'Modal Instantiation', 
                    modal instanceof MemberModal,
                    'MemberModal class instantiated successfully');

                // Test modal DOM creation
                const modalElement = document.getElementById('member-management-modal');
                addTestResult('modal-tests', 'Modal DOM Creation', 
                    modalElement !== null,
                    'Modal HTML structure created in DOM');

                // Test modal components
                const components = [
                    'modal-group-title',
                    'modal-domain-name', 
                    'member-search',
                    'members-table',
                    'bulk-accept-btn',
                    'bulk-deny-btn'
                ];

                components.forEach(componentId => {
                    const element = document.getElementById(componentId);
                    addTestResult('modal-tests', `Component: ${componentId}`, 
                        element !== null,
                        `${componentId} element found`);
                });

                // Test filter functionality
                const typeFilter = document.getElementById('type-filter');
                const statusFilter = document.getElementById('status-filter');
                const enabledFilter = document.getElementById('enabled-filter');

                addTestResult('modal-tests', 'Filter Controls', 
                    typeFilter && statusFilter && enabledFilter,
                    'All filter controls present');

                // Test search input
                const searchInput = document.getElementById('member-search');
                addTestResult('modal-tests', 'Search Functionality', 
                    searchInput && searchInput.type === 'text',
                    'Search input configured correctly');

            } catch (error) {
                addTestResult('modal-tests', 'Modal Tests', false, `Error: ${error.message}`);
            }
        }

        // Responsive Tests
        function runResponsiveTests() {
            const container = document.getElementById('responsive-tests');
            container.innerHTML = '<p>Running responsive design tests...</p>';

            try {
                // Test CSS media queries
                const testMediaQuery = window.matchMedia('(max-width: 768px)');
                addTestResult('responsive-tests', 'Media Query Support', 
                    typeof testMediaQuery.matches === 'boolean',
                    'Browser supports media queries');

                // Test viewport meta tag
                const viewportMeta = document.querySelector('meta[name="viewport"]');
                addTestResult('responsive-tests', 'Viewport Meta Tag', 
                    viewportMeta !== null,
                    'Viewport meta tag present for mobile responsiveness');

                // Test modal responsiveness
                const modalContainer = document.querySelector('.modal-container');
                if (modalContainer) {
                    const computedStyle = window.getComputedStyle(modalContainer);
                    addTestResult('responsive-tests', 'Modal Responsive Width', 
                        computedStyle.width.includes('%') || computedStyle.width.includes('vw'),
                        'Modal uses responsive width units');
                }

                // Test grid responsiveness
                const domainScannerGrid = document.querySelector('.domain-scanner-grid');
                if (domainScannerGrid) {
                    const computedStyle = window.getComputedStyle(domainScannerGrid);
                    addTestResult('responsive-tests', 'Grid Responsiveness', 
                        computedStyle.display === 'grid',
                        'Domain scanner uses CSS Grid layout');
                } else {
                    addTestWarning('responsive-tests', 'Grid Layout', 
                        'Domain scanner grid not found - may not be rendered yet');
                }

            } catch (error) {
                addTestResult('responsive-tests', 'Responsive Tests', false, `Error: ${error.message}`);
            }
        }

        // Integration Tests
        async function runIntegrationTests() {
            const container = document.getElementById('integration-tests');
            container.innerHTML = '<p>Running integration tests...</p>';

            try {
                // Test global object availability
                addTestResult('integration-tests', 'Global GroupManager', 
                    typeof window.GroupManager !== 'undefined',
                    'GroupManager available globally');

                addTestResult('integration-tests', 'Global MemberModal', 
                    typeof window.MemberModal !== 'undefined',
                    'MemberModal available globally');

                // Test Font Awesome icons
                const faTest = document.createElement('i');
                faTest.className = 'fas fa-test';
                document.body.appendChild(faTest);
                const hasFA = window.getComputedStyle(faTest, ':before').content !== 'none';
                document.body.removeChild(faTest);
                
                addTestResult('integration-tests', 'Font Awesome Icons', 
                    hasFA,
                    'Font Awesome icons are loaded and functional');

                // Test CSS custom properties
                const rootStyles = window.getComputedStyle(document.documentElement);
                const blueColor = rootStyles.getPropertyValue('--blue').trim();
                addTestResult('integration-tests', 'CSS Custom Properties', 
                    blueColor.length > 0,
                    `CSS variables loaded (--blue: ${blueColor})`);

                // Test event handling
                let eventHandled = false;
                const testButton = document.createElement('button');
                testButton.addEventListener('click', () => { eventHandled = true; });
                testButton.click();
                
                addTestResult('integration-tests', 'Event Handling', 
                    eventHandled,
                    'JavaScript event handling functional');

            } catch (error) {
                addTestResult('integration-tests', 'Integration Tests', false, `Error: ${error.message}`);
            }
        }

        // Demo functions
        function showDemoTile() {
            const demoArea = document.getElementById('demo-area');
            const mockGroup = mockGroupData[0];
            const tile = createTestGroupTile(mockGroup, 'demo.local');
            
            demoArea.innerHTML = '<h3>Demo Enhanced Group Tile:</h3>';
            demoArea.appendChild(tile);
        }

        function showDemoModal() {
            if (window.MemberModal) {
                // Show modal with demo data
                window.MemberModal.show('Demo Group', 'demo.local');
                
                // Override the API call with mock data
                setTimeout(() => {
                    if (window.MemberModal.members) {
                        window.MemberModal.members = mockMemberData.members;
                        window.MemberModal.renderMembers();
                        window.MemberModal.showInterface();
                    }
                }, 1000);
            }
        }

        // Helper function to create test tiles
        function createTestGroupTile(group, domain) {
            const tile = document.createElement('div');
            tile.className = `group-tile ${group.severity}-risk`;
            
            const acceptanceRate = group.total_members > 0 ? 
                Math.round((group.accepted_members / group.total_members) * 100) : 100;
            
            const statusIcon = group.unaccepted_members === 0 ? 'check-circle' : 'exclamation-triangle';
            const statusColor = group.unaccepted_members === 0 ? '#4CAF50' : '#FF9800';
            
            tile.innerHTML = `
                <div class="group-header">
                    <div class="group-name">${group.group_name}</div>
                    <div class="group-risk-badge ${group.severity}">
                        <span class="risk-score">${group.risk_score}</span>
                    </div>
                </div>
                
                <div class="group-status">
                    <i class="fas fa-${statusIcon}" style="color: ${statusColor};"></i>
                    <span class="status-text">
                        ${group.unaccepted_members === 0 ? 'All members accepted' : `${group.unaccepted_members} unaccepted`}
                    </span>
                </div>
                
                <div class="group-stats-enhanced">
                    <div class="stat-item">
                        <div class="stat-label">Total</div>
                        <div class="stat-value">${group.total_members}</div>
                    </div>
                    <div class="stat-item accepted">
                        <div class="stat-label">Accepted</div>
                        <div class="stat-value">${group.accepted_members}</div>
                    </div>
                    <div class="stat-item unaccepted">
                        <div class="stat-label">Unaccepted</div>
                        <div class="stat-value">${group.unaccepted_members}</div>
                    </div>
                </div>
                
                <div class="acceptance-bar">
                    <div class="acceptance-progress" style="width: ${acceptanceRate}%"></div>
                </div>
                
                <div class="group-actions">
                    <button class="btn-manage" data-group="${group.group_name}" data-domain="${domain}">
                        <i class="fas fa-cog"></i> Manage Members
                    </button>
                </div>
            `;
            
            return tile;
        }

        // Auto-run tests on page load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üß™ Phase 2 Frontend Testing Suite Loaded');
            
            // Show mock data
            const mockDataDiv = document.createElement('div');
            mockDataDiv.className = 'mock-data';
            mockDataDiv.innerHTML = `
                <h4>Mock Test Data:</h4>
                <pre>${JSON.stringify({mockGroupData, mockMemberData}, null, 2)}</pre>
            `;
            document.querySelector('.test-container').appendChild(mockDataDiv);
        });
    </script>
</body>
</html>
