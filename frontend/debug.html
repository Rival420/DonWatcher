<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DonWatcher Debug</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="app">
    <div id="sidebar"></div>
    <div class="main">
        <header class="topbar">
            <h1>Debug Information</h1>
        </header>
        <div class="content">
            <section class="card">
                <h2>System Status</h2>
                <div id="status-info">Loading...</div>
            </section>
            
            <section class="card">
                <h2>API Test</h2>
                <button onclick="testAPI()">Test All APIs</button>
                <div id="api-results"></div>
            </section>
            
            <section class="card">
                <h2>Console Logs</h2>
                <div id="console-logs" style="background: #000; color: #0f0; padding: 1em; font-family: monospace; max-height: 300px; overflow-y: auto;"></div>
            </section>
        </div>
    </div>
</div>

<script src="nav.js"></script>
<script>
// Capture console logs
const originalLog = console.log;
const originalError = console.error;
const logs = [];

console.log = function(...args) {
    logs.push({ type: 'log', message: args.join(' '), timestamp: new Date() });
    originalLog.apply(console, args);
    updateConsole();
};

console.error = function(...args) {
    logs.push({ type: 'error', message: args.join(' '), timestamp: new Date() });
    originalError.apply(console, args);
    updateConsole();
};

function updateConsole() {
    const container = document.getElementById('console-logs');
    if (container) {
        container.innerHTML = logs.slice(-20).map(log => 
            `<div style="color: ${log.type === 'error' ? '#f44' : '#0f0'}">
                [${log.timestamp.toLocaleTimeString()}] ${log.message}
            </div>`
        ).join('');
        container.scrollTop = container.scrollHeight;
    }
}

async function loadStatus() {
    try {
        const response = await fetch('/api/debug/status');
        const status = await response.json();
        
        document.getElementById('status-info').innerHTML = `
            <h3>Database Status</h3>
            <p><strong>Connected:</strong> ${status.database_connected ? '✅' : '❌'}</p>
            <p><strong>Reports Count:</strong> ${status.reports_count}</p>
            <p><strong>Findings Count:</strong> ${status.findings_count}</p>
            <p><strong>Parsers Registered:</strong> ${status.parsers_registered}</p>
            <p><strong>Database URL Set:</strong> ${status.database_url_set ? '✅' : '❌'}</p>
            ${status.error ? `<p style="color: #f44;"><strong>Error:</strong> ${status.error}</p>` : ''}
        `;
    } catch (error) {
        document.getElementById('status-info').innerHTML = `
            <p style="color: #f44;">Failed to load status: ${error.message}</p>
        `;
    }
}

async function testAPI() {
    const results = document.getElementById('api-results');
    results.innerHTML = '<p>Testing APIs...</p>';
    
    const tests = [
        { name: 'Reports API', url: '/api/reports' },
        { name: 'Analysis Scores', url: '/analysis/scores' },
        { name: 'Analysis Frequency', url: '/analysis/frequency' },
        { name: 'Accepted Risks', url: '/api/accepted_risks' },
        { name: 'Settings', url: '/api/settings' }
    ];
    
    const testResults = [];
    
    for (const test of tests) {
        try {
            const response = await fetch(test.url);
            const data = await response.json();
            testResults.push({
                name: test.name,
                status: response.ok ? 'Success' : 'Failed',
                statusCode: response.status,
                dataLength: Array.isArray(data) ? data.length : Object.keys(data).length
            });
        } catch (error) {
            testResults.push({
                name: test.name,
                status: 'Error',
                error: error.message
            });
        }
    }
    
    results.innerHTML = `
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #333;">
                    <th style="padding: 0.5em; border: 1px solid #666;">API</th>
                    <th style="padding: 0.5em; border: 1px solid #666;">Status</th>
                    <th style="padding: 0.5em; border: 1px solid #666;">Code</th>
                    <th style="padding: 0.5em; border: 1px solid #666;">Data Length</th>
                </tr>
            </thead>
            <tbody>
                ${testResults.map(result => `
                    <tr>
                        <td style="padding: 0.5em; border: 1px solid #666;">${result.name}</td>
                        <td style="padding: 0.5em; border: 1px solid #666; color: ${result.status === 'Success' ? '#4f4' : '#f44'};">${result.status}</td>
                        <td style="padding: 0.5em; border: 1px solid #666;">${result.statusCode || 'N/A'}</td>
                        <td style="padding: 0.5em; border: 1px solid #666;">${result.dataLength || result.error || 'N/A'}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

document.addEventListener('DOMContentLoaded', () => {
    loadStatus();
    console.log('Debug page loaded');
});
</script>
</body>
</html>

