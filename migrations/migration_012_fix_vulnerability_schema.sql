-- Migration 012: Fix Vulnerability Schema
-- 
-- This migration corrects the vulnerability analysis data model:
-- - The "agents_in_sync" field from DASHBOARD_TOPGROUPS is actually the total vulnerability count
-- - The total_vulnerabilities field should hold the grand total from DASHBOARD_TOPGROUPS
-- - High/Medium/Low are the breakdown from DASHBOARD_RISKSUMMARY
--
-- Changes:
-- 1. Deprecate agents_in_sync column (keep for backward compatibility, no longer used)
-- 2. Update views to exclude agents_in_sync
-- 3. Add comments for documentation

-- =============================================================================
-- Update column comments
-- =============================================================================

COMMENT ON COLUMN vulnerability_scores.total_vulnerabilities IS 'Total vulnerability count from Outpost24 DASHBOARD_TOPGROUPS (grand total)';
COMMENT ON COLUMN vulnerability_scores.high_vulnerabilities IS 'High severity vulnerability count from DASHBOARD_RISKSUMMARY';
COMMENT ON COLUMN vulnerability_scores.medium_vulnerabilities IS 'Medium severity vulnerability count from DASHBOARD_RISKSUMMARY';
COMMENT ON COLUMN vulnerability_scores.low_vulnerabilities IS 'Low severity vulnerability count from DASHBOARD_RISKSUMMARY';
COMMENT ON COLUMN vulnerability_scores.agents_in_sync IS 'DEPRECATED: No longer used. Column kept for backward compatibility with existing data.';

-- =============================================================================
-- Update the Latest Vulnerability Scores View
-- =============================================================================

CREATE OR REPLACE VIEW v_latest_vulnerability_scores AS
SELECT DISTINCT ON (domain)
    id,
    domain,
    scan_date,
    total_vulnerabilities,
    high_vulnerabilities,
    medium_vulnerabilities,
    low_vulnerabilities,
    high_trend,
    medium_trend,
    low_trend,
    risk_score,
    source_timestamp,
    scanner_name,
    created_at,
    updated_at
FROM vulnerability_scores
ORDER BY domain, scan_date DESC;

COMMENT ON VIEW v_latest_vulnerability_scores IS 'Latest vulnerability scores for each domain (excludes deprecated agents_in_sync)';

-- =============================================================================
-- Update the Vulnerability Dashboard View
-- =============================================================================

CREATE OR REPLACE VIEW v_vulnerability_dashboard AS
SELECT 
    vs.domain,
    vs.scan_date,
    vs.total_vulnerabilities,
    vs.high_vulnerabilities,
    vs.medium_vulnerabilities,
    vs.low_vulnerabilities,
    vs.high_trend,
    vs.medium_trend,
    vs.low_trend,
    vs.risk_score,
    -- Risk level based on score
    CASE 
        WHEN vs.risk_score >= 75 THEN 'critical'
        WHEN vs.risk_score >= 50 THEN 'high'
        WHEN vs.risk_score >= 25 THEN 'medium'
        ELSE 'low'
    END as risk_level,
    -- Trend direction
    CASE 
        WHEN (vs.high_trend + vs.medium_trend + vs.low_trend) > 0 THEN 'increasing'
        WHEN (vs.high_trend + vs.medium_trend + vs.low_trend) < 0 THEN 'decreasing'
        ELSE 'stable'
    END as trend_direction,
    vs.created_at
FROM vulnerability_scores vs
WHERE vs.scan_date = (
    SELECT MAX(scan_date) 
    FROM vulnerability_scores 
    WHERE domain = vs.domain
);

COMMENT ON VIEW v_vulnerability_dashboard IS 'Dashboard summary view for vulnerability scores (excludes deprecated agents_in_sync)';

-- =============================================================================
-- Update the Vulnerability History View
-- =============================================================================

CREATE OR REPLACE VIEW v_vulnerability_history AS
SELECT 
    domain,
    scan_date,
    total_vulnerabilities,
    high_vulnerabilities,
    medium_vulnerabilities,
    low_vulnerabilities,
    risk_score
FROM vulnerability_scores
ORDER BY domain, scan_date ASC;

COMMENT ON VIEW v_vulnerability_history IS 'Historical vulnerability data for trend charts (excludes deprecated agents_in_sync)';


