-- Migration 011: Add Vulnerability Analysis Scores (Outpost24)
-- 
-- This migration adds support for tracking vulnerability scan data from Outpost24
-- Outscan platform. Data is collected via PowerShell script and uploaded via API.
--
-- Two main data sources are merged:
-- 1. DASHBOARD_TOPGROUPS - Agent sync counts
-- 2. DASHBOARD_RISKSUMMARY - Vulnerability counts by severity with trends

-- =============================================================================
-- Vulnerability Scores Table
-- =============================================================================

CREATE TABLE IF NOT EXISTS vulnerability_scores (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    domain TEXT NOT NULL,
    scan_date TIMESTAMP WITH TIME ZONE NOT NULL,
    
    -- ==========================================================================
    -- Agent/Asset Information (from DASHBOARD_TOPGROUPS)
    -- ==========================================================================
    agents_in_sync INTEGER NOT NULL DEFAULT 0,
    
    -- ==========================================================================
    -- Vulnerability Counts (from DASHBOARD_RISKSUMMARY)
    -- ==========================================================================
    total_vulnerabilities INTEGER NOT NULL DEFAULT 0,
    high_vulnerabilities INTEGER NOT NULL DEFAULT 0,
    medium_vulnerabilities INTEGER NOT NULL DEFAULT 0,
    low_vulnerabilities INTEGER NOT NULL DEFAULT 0,
    
    -- ==========================================================================
    -- Trend Information (from DASHBOARD_RISKSUMMARY)
    -- Shows change since last scan
    -- ==========================================================================
    high_trend INTEGER NOT NULL DEFAULT 0,
    medium_trend INTEGER NOT NULL DEFAULT 0,
    low_trend INTEGER NOT NULL DEFAULT 0,
    
    -- ==========================================================================
    -- Calculated Risk Score (0-100)
    -- Higher = worse (more vulnerabilities)
    -- Formula: weighted average based on severity
    -- ==========================================================================
    risk_score DECIMAL(5,2) NOT NULL DEFAULT 0,
    
    -- ==========================================================================
    -- Source Metadata
    -- ==========================================================================
    source_timestamp TEXT,  -- Original timestamp from Outpost24 API
    scanner_name TEXT DEFAULT 'outpost24',
    
    -- ==========================================================================
    -- Audit Fields
    -- ==========================================================================
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    -- Constraint: One entry per domain per scan date (allows multiple per day)
    UNIQUE(domain, scan_date)
);

-- Comments for documentation
COMMENT ON TABLE vulnerability_scores IS 'Vulnerability scan data from Outpost24 Outscan, collected via PowerShell scanner';
COMMENT ON COLUMN vulnerability_scores.agents_in_sync IS 'Number of Outpost24 agents currently in sync';
COMMENT ON COLUMN vulnerability_scores.total_vulnerabilities IS 'Total vulnerability count across all severities';
COMMENT ON COLUMN vulnerability_scores.high_vulnerabilities IS 'High severity vulnerability count';
COMMENT ON COLUMN vulnerability_scores.medium_vulnerabilities IS 'Medium severity vulnerability count';
COMMENT ON COLUMN vulnerability_scores.low_vulnerabilities IS 'Low severity vulnerability count';
COMMENT ON COLUMN vulnerability_scores.high_trend IS 'Change in high severity vulns since last scan';
COMMENT ON COLUMN vulnerability_scores.medium_trend IS 'Change in medium severity vulns since last scan';
COMMENT ON COLUMN vulnerability_scores.low_trend IS 'Change in low severity vulns since last scan';
COMMENT ON COLUMN vulnerability_scores.risk_score IS 'Calculated risk score 0-100 (higher = more risk)';

-- =============================================================================
-- Indexes for Performance
-- =============================================================================

CREATE INDEX IF NOT EXISTS idx_vulnerability_scores_domain 
    ON vulnerability_scores(domain);

CREATE INDEX IF NOT EXISTS idx_vulnerability_scores_date 
    ON vulnerability_scores(scan_date DESC);

CREATE INDEX IF NOT EXISTS idx_vulnerability_scores_domain_date 
    ON vulnerability_scores(domain, scan_date DESC);

-- =============================================================================
-- Update Global Risk Scores to Include Vulnerability Data
-- =============================================================================

ALTER TABLE global_risk_scores 
    ADD COLUMN IF NOT EXISTS vulnerability_score DECIMAL(5,2);

ALTER TABLE global_risk_scores 
    ADD COLUMN IF NOT EXISTS vulnerability_contribution DECIMAL(5,2);

COMMENT ON COLUMN global_risk_scores.vulnerability_score IS 'Vulnerability risk score at time of assessment (NULL if no vulnerability data)';
COMMENT ON COLUMN global_risk_scores.vulnerability_contribution IS 'Percentage contribution of vulnerability to global score';

-- =============================================================================
-- Update Risk Configuration for Vulnerability Weight
-- =============================================================================

ALTER TABLE risk_configuration
    ADD COLUMN IF NOT EXISTS vulnerability_weight DECIMAL(3,2) DEFAULT 0.20;

COMMENT ON COLUMN risk_configuration.vulnerability_weight IS 'Weight of vulnerability score in global risk calculation (default 20%)';

-- Update existing configurations to have vulnerability_weight
UPDATE risk_configuration 
SET vulnerability_weight = 0.20
WHERE vulnerability_weight IS NULL;

-- =============================================================================
-- Add Security Tool Type for Vulnerability Scanner
-- =============================================================================

-- Check if enum value exists before adding (PostgreSQL 9.1+)
DO $$ 
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_enum 
        WHERE enumlabel = 'vulnerability_analysis' 
        AND enumtypid = (SELECT oid FROM pg_type WHERE typname = 'security_tool_type')
    ) THEN
        ALTER TYPE security_tool_type ADD VALUE 'vulnerability_analysis';
    END IF;
END $$;

-- =============================================================================
-- View for Latest Vulnerability Scores per Domain
-- =============================================================================

CREATE OR REPLACE VIEW v_latest_vulnerability_scores AS
SELECT DISTINCT ON (domain)
    id,
    domain,
    scan_date,
    agents_in_sync,
    total_vulnerabilities,
    high_vulnerabilities,
    medium_vulnerabilities,
    low_vulnerabilities,
    high_trend,
    medium_trend,
    low_trend,
    risk_score,
    source_timestamp,
    scanner_name,
    created_at,
    updated_at
FROM vulnerability_scores
ORDER BY domain, scan_date DESC;

COMMENT ON VIEW v_latest_vulnerability_scores IS 'Latest vulnerability scores for each domain';

-- =============================================================================
-- Vulnerability Dashboard Summary View
-- =============================================================================

CREATE OR REPLACE VIEW v_vulnerability_dashboard AS
SELECT 
    vs.domain,
    vs.scan_date,
    vs.agents_in_sync,
    vs.total_vulnerabilities,
    vs.high_vulnerabilities,
    vs.medium_vulnerabilities,
    vs.low_vulnerabilities,
    vs.high_trend,
    vs.medium_trend,
    vs.low_trend,
    vs.risk_score,
    -- Risk level based on score
    CASE 
        WHEN vs.risk_score >= 75 THEN 'critical'
        WHEN vs.risk_score >= 50 THEN 'high'
        WHEN vs.risk_score >= 25 THEN 'medium'
        ELSE 'low'
    END as risk_level,
    -- Trend direction
    CASE 
        WHEN (vs.high_trend + vs.medium_trend + vs.low_trend) > 0 THEN 'increasing'
        WHEN (vs.high_trend + vs.medium_trend + vs.low_trend) < 0 THEN 'decreasing'
        ELSE 'stable'
    END as trend_direction,
    vs.created_at
FROM vulnerability_scores vs
WHERE vs.scan_date = (
    SELECT MAX(scan_date) 
    FROM vulnerability_scores 
    WHERE domain = vs.domain
);

COMMENT ON VIEW v_vulnerability_dashboard IS 'Dashboard summary view for vulnerability scores with trend information';

-- =============================================================================
-- Vulnerability Trend History View (for charts)
-- =============================================================================

CREATE OR REPLACE VIEW v_vulnerability_history AS
SELECT 
    domain,
    scan_date,
    total_vulnerabilities,
    high_vulnerabilities,
    medium_vulnerabilities,
    low_vulnerabilities,
    risk_score,
    agents_in_sync
FROM vulnerability_scores
ORDER BY domain, scan_date ASC;

COMMENT ON VIEW v_vulnerability_history IS 'Historical vulnerability data for trend charts';

