<#
.SYNOPSIS
    DonWatcher Vulnerability Scanner v1.0
    
.DESCRIPTION
    Collects vulnerability data from Outpost24 Outscan API and uploads to DonWatcher.
    
    This script merges data from two Outpost24 API endpoints:
    - DASHBOARD_TOPGROUPS: Total vulnerability count (via "Agents in sync" metric)
    - DASHBOARD_RISKSUMMARY: Vulnerability breakdown by severity with trends
    
.PARAMETER DonWatcherUrl
    URL of the DonWatcher server (e.g., http://donwatcher:8080)
    
.PARAMETER Domain
    Domain name to associate with the vulnerability data
    
.PARAMETER ApiToken
    Outpost24 API token (can also be set via OUTPOST24_TOKEN environment variable)
    
.PARAMETER ConfigFile
    Path to JSON configuration file (default: DonWatcher-VulnerabilityScanner-Config.json)
    
.PARAMETER TestConnection
    Only test connectivity to DonWatcher and Outpost24, do not scan

.EXAMPLE
    .\DonWatcher-VulnerabilityScanner.ps1 -DonWatcherUrl "http://donwatcher:8080" -Domain "CORP.LOCAL"
    
.EXAMPLE
    .\DonWatcher-VulnerabilityScanner.ps1 -TestConnection
    
.NOTES
    Version: 1.0
    Requires: PowerShell 5.1+
    API: Outpost24 Outscan XMLAPI
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory = $false)]
    [string]$DonWatcherUrl,

    [Parameter(Mandatory = $false)]
    [string]$Domain,

    [Parameter(Mandatory = $false)]
    [string]$ApiToken,

    [Parameter(Mandatory = $false)]
    [string]$ConfigFile = "DonWatcher-VulnerabilityScanner-Config.json",

    [Parameter(Mandatory = $false)]
    [switch]$TestConnection
)

$ErrorActionPreference = "Stop"

# =============================================================================
# Configuration
# =============================================================================

$DefaultConfig = @{
    DonWatcherUrl   = "http://localhost:8080"
    Outpost24BaseUrl = "https://outscan.outpost24.com/opi/XMLAPI"
    Domain          = "CORP.LOCAL"
    TimeoutSeconds  = 120
}

function Load-Configuration {
    param([string]$Path)
    
    $config = $DefaultConfig.Clone()
    
    if (Test-Path $Path) {
        try {
            $fileConfig = Get-Content $Path -Raw -Encoding UTF8 | ConvertFrom-Json
            foreach ($prop in $fileConfig.PSObject.Properties) {
                $config[$prop.Name] = $prop.Value
            }
            Write-Verbose "Loaded configuration from: $Path"
        }
        catch {
            Write-Warning "Failed to load config file: $($_.Exception.Message). Using defaults."
        }
    }
    else {
        Write-Host "[INFO] Creating default configuration file: $Path" -ForegroundColor Cyan
        @{
            DonWatcherUrl    = $config.DonWatcherUrl
            Outpost24BaseUrl = $config.Outpost24BaseUrl
            Domain           = $config.Domain
            TimeoutSeconds   = $config.TimeoutSeconds
            # Note: API token should be set via environment variable or passed as parameter
            # ApiToken       = "YOUR_TOKEN_HERE"  # Uncomment and set if needed
        } | ConvertTo-Json -Depth 3 | Out-File $Path -Encoding UTF8
        Write-Host "[INFO] Edit $Path to customize settings" -ForegroundColor Yellow
    }
    
    return $config
}

$Config = Load-Configuration -Path $ConfigFile

# Override config with command line parameters
if ($DonWatcherUrl) { $Config.DonWatcherUrl = $DonWatcherUrl }
if ($Domain) { $Config.Domain = $Domain }
if ($ApiToken) { $Config.ApiToken = $ApiToken }

# Check for API token in environment variable if not in config
if (-not $Config.ApiToken) {
    $Config.ApiToken = $env:OUTPOST24_TOKEN
}

# =============================================================================
# Validation
# =============================================================================

function Test-ApiToken {
    param([string]$Token)
    
    if ([string]::IsNullOrWhiteSpace($Token)) {
        return $false
    }
    
    if ($Token -match '[<>]') {
        return $false
    }
    
    return $true
}

# =============================================================================
# Connection Tests
# =============================================================================

function Test-DonWatcherConnection {
    param([string]$BaseUrl)
    
    Write-Host "[INFO] Testing connection to DonWatcher: $BaseUrl" -ForegroundColor Cyan
    
    try {
        $response = Invoke-RestMethod -Uri "$BaseUrl/api/debug/status" -Method Get -TimeoutSec 30
        Write-Host "[OK] Connected to DonWatcher" -ForegroundColor Green
        Write-Host "     Server Status    : $($response.status)" -ForegroundColor Gray
        Write-Host "     Reports in DB    : $($response.reports_count)" -ForegroundColor Gray
        return $response
    }
    catch {
        Write-Host "[ERROR] Cannot connect to DonWatcher: $($_.Exception.Message)" -ForegroundColor Red
        return $null
    }
}

function Test-Outpost24Connection {
    param([string]$BaseUrl, [string]$Token)
    
    Write-Host "[INFO] Testing connection to Outpost24: $BaseUrl" -ForegroundColor Cyan
    
    if (-not (Test-ApiToken -Token $Token)) {
        Write-Host "[ERROR] Invalid or missing API token" -ForegroundColor Red
        Write-Host "        Set via: -ApiToken parameter, OUTPOST24_TOKEN env var, or config file" -ForegroundColor Yellow
        return $false
    }
    
    try {
        $query = "ACTION=DASHBOARD_TOPGROUPS&APPTOKEN=$([uri]::EscapeDataString($Token))"
        $uriBuilder = [System.UriBuilder]$BaseUrl
        $uriBuilder.Query = $query
        $uri = $uriBuilder.Uri.AbsoluteUri
        
        $response = Invoke-WebRequest -Uri $uri -Method GET -TimeoutSec 30 -UseBasicParsing
        [xml]$xml = $response.Content
        
        if ($xml.RESPONSE) {
            Write-Host "[OK] Connected to Outpost24 Outscan API" -ForegroundColor Green
            return $true
        }
        else {
            Write-Host "[ERROR] Unexpected response from Outpost24" -ForegroundColor Red
            return $false
        }
    }
    catch {
        Write-Host "[ERROR] Cannot connect to Outpost24: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# =============================================================================
# Data Collection from Outpost24
# =============================================================================

function Get-TotalVulnerabilities {
    param([string]$BaseUrl, [string]$Token)
    
    Write-Host "[INFO] Fetching total vulnerability count..." -ForegroundColor Cyan
    
    try {
        $query = "ACTION=DASHBOARD_TOPGROUPS&APPTOKEN=$([uri]::EscapeDataString($Token))"
        $uriBuilder = [System.UriBuilder]$BaseUrl
        $uriBuilder.Query = $query
        $uri = $uriBuilder.Uri.AbsoluteUri
        
        $response = Invoke-WebRequest -Uri $uri -Method GET -TimeoutSec 30 -UseBasicParsing
        [xml]$xml = $response.Content
        
        # The "Agents in sync" metric in Outpost24 represents the total vulnerability count
        $targetNode = $xml.RESPONSE.TOPGROUPS.STAT | Where-Object { $_.NAME -eq "Agents in sync" }
        
        if (-not $targetNode) {
            $available = ($xml.RESPONSE.TOPGROUPS.STAT | ForEach-Object { $_.NAME }) -join ", "
            Write-Warning "Could not find 'Agents in sync' (total vulnerabilities). Available: $available"
            return 0
        }
        
        $count = [int]$targetNode.COUNT
        Write-Host "     Total Vulns (TOPGROUPS): $count" -ForegroundColor Gray
        return $count
    }
    catch {
        Write-Warning "Failed to get total vulnerability count: $($_.Exception.Message)"
        return 0
    }
}

function Get-RiskSummary {
    param([string]$BaseUrl, [string]$Token)
    
    Write-Host "[INFO] Fetching vulnerability risk summary..." -ForegroundColor Cyan
    
    try {
        $query = "ACTION=DASHBOARD_RISKSUMMARY&APPTOKEN=$([uri]::EscapeDataString($Token))"
        $uriBuilder = [System.UriBuilder]$BaseUrl
        $uriBuilder.Query = $query
        $uri = $uriBuilder.Uri.AbsoluteUri
        
        $response = Invoke-WebRequest -Uri $uri -Method GET -TimeoutSec 30 -UseBasicParsing
        [xml]$xml = $response.Content
        
        # Get the first STAT row
        $stat = $xml.RESPONSE.RISKCOUNT.STAT | Select-Object -First 1
        if (-not $stat) {
            throw "No STAT node found in RISKCOUNT"
        }
        
        $result = [PSCustomObject]@{
            Timestamp   = $xml.RESPONSE.TIMESTAMP
            Total       = [int]$stat.TOTAL
            High        = [int]$stat.HIGH
            Medium      = [int]$stat.MEDIUM
            Low         = [int]$stat.LOW
            HighTrend   = [int]$stat.HIGHTREND
            MediumTrend = [int]$stat.MEDIUMTREND
            LowTrend    = [int]$stat.LOWTREND
        }
        
        Write-Host "     Timestamp        : $($result.Timestamp)" -ForegroundColor Gray
        Write-Host "     Total Vulns      : $($result.Total)" -ForegroundColor Gray
        Write-Host "     High             : $($result.High) (trend: $($result.HighTrend))" -ForegroundColor Gray
        Write-Host "     Medium           : $($result.Medium) (trend: $($result.MediumTrend))" -ForegroundColor Gray
        Write-Host "     Low              : $($result.Low) (trend: $($result.LowTrend))" -ForegroundColor Gray
        
        return $result
    }
    catch {
        Write-Error "Failed to get risk summary: $($_.Exception.Message)"
        throw
    }
}

# =============================================================================
# Upload to DonWatcher
# =============================================================================

function Send-ToDonWatcher {
    param(
        [string]$BaseUrl,
        [string]$Domain,
        [int]$TotalVulnerabilities,
        [PSCustomObject]$RiskSummary,
        [int]$TimeoutSeconds
    )
    
    $apiUrl = "$BaseUrl/api/vulnerability/scores"
    Write-Host "[INFO] Uploading to DonWatcher: $apiUrl" -ForegroundColor Cyan
    
    # Build request body matching API schema
    # total_vulnerabilities: the grand total from DASHBOARD_TOPGROUPS
    # high/medium/low_vulnerabilities: breakdown from DASHBOARD_RISKSUMMARY
    $requestBody = @{
        domain                  = $Domain
        total_vulnerabilities   = $TotalVulnerabilities
        high_vulnerabilities    = $RiskSummary.High
        medium_vulnerabilities  = $RiskSummary.Medium
        low_vulnerabilities     = $RiskSummary.Low
        high_trend              = $RiskSummary.HighTrend
        medium_trend            = $RiskSummary.MediumTrend
        low_trend               = $RiskSummary.LowTrend
        source_timestamp        = $RiskSummary.Timestamp
        scanner_name            = "outpost24"
    }
    
    # Convert to JSON
    $jsonBody = $requestBody | ConvertTo-Json -Depth 10 -Compress
    
    # Encode as UTF-8
    $utf8Bytes = [System.Text.Encoding]::UTF8.GetBytes($jsonBody)
    
    try {
        $response = Invoke-RestMethod -Uri $apiUrl -Method Post `
            -ContentType "application/json; charset=utf-8" `
            -Body $utf8Bytes `
            -TimeoutSec $TimeoutSeconds
        
        Write-Host "[OK] Upload successful" -ForegroundColor Green
        Write-Host "     Score ID         : $($response.score_id)" -ForegroundColor Gray
        Write-Host "     Domain           : $($response.domain)" -ForegroundColor Gray
        Write-Host "     Scan Date        : $($response.scan_date)" -ForegroundColor Gray
        Write-Host "     Total Vulns      : $($response.vulnerabilities.total)" -ForegroundColor Gray
        return $true
    }
    catch {
        $errorMsg = $_.Exception.Message
        
        # Try to extract detailed error from response
        if ($_.Exception.Response) {
            try {
                $stream = $_.Exception.Response.GetResponseStream()
                $reader = [System.IO.StreamReader]::new($stream)
                $responseBody = $reader.ReadToEnd()
                $reader.Close()
                if ($responseBody) {
                    $errorDetail = $responseBody | ConvertFrom-Json -ErrorAction SilentlyContinue
                    if ($errorDetail.detail) {
                        $errorMsg = "$errorMsg - $($errorDetail.detail)"
                    }
                }
            }
            catch {}
        }
        
        Write-Host "[ERROR] Upload failed: $errorMsg" -ForegroundColor Red
        return $false
    }
}

# =============================================================================
# Main
# =============================================================================

function Main {
    Write-Host "==========================================" -ForegroundColor Cyan
    Write-Host " DonWatcher Vulnerability Scanner v1.0" -ForegroundColor Cyan
    Write-Host " (Outpost24 Outscan Integration)" -ForegroundColor Cyan
    Write-Host "==========================================" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "[INFO] Configuration:" -ForegroundColor Cyan
    Write-Host "     Config File      : $ConfigFile" -ForegroundColor Gray
    Write-Host "     DonWatcher URL   : $($Config.DonWatcherUrl)" -ForegroundColor Gray
    Write-Host "     Outpost24 URL    : $($Config.Outpost24BaseUrl)" -ForegroundColor Gray
    Write-Host "     Domain           : $($Config.Domain)" -ForegroundColor Gray
    Write-Host "     API Token        : $(if ($Config.ApiToken) { '***configured***' } else { 'NOT SET' })" -ForegroundColor Gray
    Write-Host ""
    
    # Validate API token
    if (-not (Test-ApiToken -Token $Config.ApiToken)) {
        Write-Host "[ERROR] API token is required but not configured" -ForegroundColor Red
        Write-Host "" -ForegroundColor Red
        Write-Host "Set the API token using one of these methods:" -ForegroundColor Yellow
        Write-Host "  1. Command line: -ApiToken 'your-token'" -ForegroundColor Gray
        Write-Host "  2. Environment variable: `$env:OUTPOST24_TOKEN = 'your-token'" -ForegroundColor Gray
        Write-Host "  3. Config file: Add 'ApiToken' to $ConfigFile" -ForegroundColor Gray
        exit 1
    }
    
    # Test connections
    $dwStatus = Test-DonWatcherConnection -BaseUrl $Config.DonWatcherUrl
    if (-not $dwStatus) { exit 1 }
    
    $o24Status = Test-Outpost24Connection -BaseUrl $Config.Outpost24BaseUrl -Token $Config.ApiToken
    if (-not $o24Status) { exit 1 }
    
    if ($TestConnection) {
        Write-Host "`n[SUCCESS] Connection tests completed" -ForegroundColor Green
        exit 0
    }
    
    Write-Host ""
    
    # Collect data from Outpost24
    try {
        $totalVulnerabilities = Get-TotalVulnerabilities -BaseUrl $Config.Outpost24BaseUrl -Token $Config.ApiToken
        $riskSummary = Get-RiskSummary -BaseUrl $Config.Outpost24BaseUrl -Token $Config.ApiToken
    }
    catch {
        Write-Host "[ERROR] Failed to collect data from Outpost24: $($_.Exception.Message)" -ForegroundColor Red
        exit 1
    }
    
    Write-Host ""
    Write-Host "[INFO] Data Collection Summary:" -ForegroundColor Cyan
    Write-Host "     Total Vulns      : $totalVulnerabilities" -ForegroundColor White
    Write-Host "     High Severity    : $($riskSummary.High) (trend: $($riskSummary.HighTrend))" -ForegroundColor Red
    Write-Host "     Medium Severity  : $($riskSummary.Medium) (trend: $($riskSummary.MediumTrend))" -ForegroundColor Yellow
    Write-Host "     Low Severity     : $($riskSummary.Low) (trend: $($riskSummary.LowTrend))" -ForegroundColor Green
    Write-Host ""
    
    # Upload to DonWatcher
    if (Send-ToDonWatcher -BaseUrl $Config.DonWatcherUrl `
                          -Domain $Config.Domain `
                          -TotalVulnerabilities $totalVulnerabilities `
                          -RiskSummary $riskSummary `
                          -TimeoutSeconds $Config.TimeoutSeconds) {
        Write-Host "`n[SUCCESS] Vulnerability scan completed successfully" -ForegroundColor Green
        exit 0
    }
    else {
        Write-Host "`n[ERROR] Vulnerability scan completed but upload failed" -ForegroundColor Red
        exit 1
    }
}

Main

